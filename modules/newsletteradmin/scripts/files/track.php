<?php/** * Mails tracking to AdminNewsletter tab * @category  PSadmin * @copyright eolia.o2switch.net * @license http://www.opensource.org/licenses/osl-3.0.php Open-source licence 3.0 * @Author Eolia  31/03/2012 compatible PS1.3 - 1.4 * @version 2.2 */include(dirname(__FILE__).'/config/config.inc.php');include(dirname(__FILE__).'/modules/newsletteradmin/functions.php');$filename = 'TRACK';			dbconnect();			if (isSet($_SERVER)){				if (isSet($_SERVER["HTTP_X_FORWARDED_FOR"])) {$ipAddress = $_SERVER["HTTP_X_FORWARDED_FOR"];				} elseif (isSet($_SERVER["HTTP_CLIENT_IP"])) {$ipAddress = $_SERVER["HTTP_CLIENT_IP"];				} else $ipAddress = $_SERVER["REMOTE_ADDR"];								}			 else 	{				if ( getenv( 'HTTP_X_FORWARDED_FOR' ) ) {$ipAddress = getenv( 'HTTP_X_FORWARDED_FOR' );				} elseif ( getenv( 'HTTP_CLIENT_IP' ) ) {$ipAddress = getenv( 'HTTP_CLIENT_IP' );				} else $ipAddress = getenv( 'REMOTE_ADDR' );					}			// Verify if the campaign number is an integer			function myIsInt($x) {  			   return(is_numeric($x) ? intval(0+$x) == $x : false);   			}									if (isset($_GET['email']) AND isset($_GET['id_campaign']) AND isset($_GET['subject'])){ //Prevent hacks			$email = $_GET['email'];			if (!Validate::isEmail($email)) die('Invalid email address');			$postDate = date("d-m-Y");			$postTime = date("H-i-s");			$today = date('d-m-Y H:i:s');			$id_campaign = $_GET['id_campaign'];			$subject = $_GET['subject'];			if (myIsInt($id_campaign) == false) die('Are you crazy?');			//Verify if the campaign exists	 			$verif = "SELECT MAX(id_campaign), subject FROM "._DB_PREFIX_."mailing_history";				$res1 = mysql_query($verif);                $req1 = mysql_result($res1,0,"MAX(id_campaign)");				if ($id_campaign <= 0 or $req1 < $id_campaign) die(trans('This campaign not exist!'));							$verif2 = "SELECT subject FROM "._DB_PREFIX_."mailing_history WHERE id_campaign = $req1";					$res2 = mysql_query($verif2);				$data = mysql_fetch_array($res2); 				$subject = $data['subject'];				if ($subject != $data['subject']) die(trans('This subject not exist!'));			//store the result if this email is not registerd yet			$test = mysql_query("SELECT count(email) as total FROM "._DB_PREFIX_."mailing_track WHERE email='$email' AND id_campaign='$id_campaign'");                $req2 = mysql_fetch_array($test);			// if not open                			if ($req2['total'] == 0)                {					$sql2 ="insert into "._DB_PREFIX_."mailing_track (ipaddress, id_campaign, subject, postDate, postTime, email) values('$ipAddress','$id_campaign', '$subject','$postDate','$postTime','$email')";					mysql_query($sql2) or die('Erreur SQL !'.$sql2.'<br />'.mysql_error());					$sql3 ="UPDATE "._DB_PREFIX_."mailing_sent SET `dateReceived`='$today' WHERE `id_campaign` = '$id_campaign' AND `email` = '$email'";					mysql_query($sql3) or die('Erreur SQL !'.$sql3.'<br />'.mysql_error());                  echo 'OK <br/>';				}			// if already open				else{ echo trans('This result is already registred').'<br/>';} 			// Clean the table after 10 campaigns			if ($id_campaign >10)			{							$id_camp_old = ($id_campaign - 10);						$sql ="DELETE  FROM "._DB_PREFIX_."mailing_track WHERE id_campaign ='$id_camp_old'";			mysql_query($sql)or die ('Erreur SQL !'.$sql.'<br />'.mysql_error());			$sql ="OPTIMIZE TABLE "._DB_PREFIX_."mailing_track ";			mysql_query($sql)or die ('Erreur SQL !'.$sql.'<br />'.mysql_error());			$sql ="DELETE  FROM "._DB_PREFIX_."mailing_history WHERE id_campaign ='$id_camp_old'";			mysql_query($sql)or die ('Erreur SQL !'.$sql.'<br />'.mysql_error());			$sql ="OPTIMIZE TABLE "._DB_PREFIX_."mailing_history ";			mysql_query($sql)or die ('Erreur SQL !'.$sql.'<br />'.mysql_error());			}				else{ $id_camp_old = trans('Not enough campaigns');			}			}else  die('Bad or malformed request...');			mysql_close($req);			//only for test with direct adressecho trans('Your IP is').': '.$ipAddress;echo '<br/>'.trans('Campaign number').': '.$id_campaign;echo '<br/>'.trans('Oldest campaign').': '.$id_camp_old;?>